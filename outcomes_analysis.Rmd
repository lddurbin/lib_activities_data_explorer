---
title: "`r paste0('Libraries Programmes and Events: ', params$outcome, ' Outcome Analysis (', params$month, ' ', params$year, ')')`"
author: "`r paste0('Compiled by Lee Durbin', params$outcome_owner)`"
date: "`r paste0(params$month, ' ', params$year)`"
output:
  rmdformats::readthedown:
    highlight: kate
params:
  year: 2021
  month: July
  outcome: "Literacy"
  outcome_owner: " for Kirstin Kane"
  outcome_url: https://aklcouncil.sharepoint.com/sites/tools-to-do-my-job/SitePages/Literacy-@-Auckland-Libraries.aspx
  outcome_file_location: "https://aklcouncil-my.sharepoint.com/:u:/g/personal/durbinl_aklc_govt_nz/ERYJdFxlCldJlaO2WrWSfcUBaHjG4Xpyj4MRlK_J-IhgIg?e=ghPcMt?download=1"
---


```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
library(tidyverse)
library(scales)
library(waffle)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)

common_table_headings <- c('Sessions', 'Participants (18+)', 'Participants (under 18)', 'Total Duration')

source("data_prep.R")
```

## Overview

```{r overview}
# How many sessions were entered into the form?
monthly_submissions <- joined_data %>% 
  filter(month(as_date(delivery_datetime), label = TRUE, abbr = FALSE) == params$month & year(as_date(delivery_datetime)) == params$year) %>% 
  distinct(id) %>% 
  nrow()

# Of these, how many delivered against an outcome?
outcome_submissions <- joined_data %>% 
  filter(!is.na(outcome) & month(as_date(delivery_datetime), label = TRUE, abbr = FALSE) == params$month & year(as_date(delivery_datetime)) == params$year) %>% 
  distinct(id) %>% 
  nrow()

# Filter down to an outcome area
outcome_data <- joined_data %>% 
  filter(month(as_date(delivery_datetime), label = TRUE, abbr = FALSE) == params$month & year(as_date(delivery_datetime)) == params$year & outcome == params$outcome)

# Stats for sessions that delivered against a given outcome area
this_outcome <- outcome_data %>% 
  distinct(id, outcome, .keep_all = TRUE) %>% 
  summarise_data(outcome)
```

In `r params$month` `r params$year`, **`r prettyNum(monthly_submissions, big.mark = ",")`** in-scope programmes, events, and Book a Librarian sessions were delivered across Tāmaki Makaurau. You can browse through the complete dataset by downloading the [Data Explorer](https://aklcouncil-my.sharepoint.com/:u:/g/personal/durbinl_aklc_govt_nz/ES56_6mDLOZIqrzoyLDpwU0B7R5rNPIhN2MYSSzAr_CYTA?download=1).

Of these `r prettyNum(monthly_submissions, big.mark = ",")` activities, a total of **`r prettyNum(outcome_submissions, big.mark = ",")`** were reported as having delivered against one of the six outcome areas. In other words, **`r round((outcome_submissions/monthly_submissions)*100)`%** of the in-scope libraries activities delivered in `r params$month` `r params$year` were reported as having delivered against at least one of the following outcomes:

* Environment
* Heritage
* Kia Ora Tāmaki Makaurau
* Literacy
* Talanoa Pasifika
* Tātou Belonging

Of the `r prettyNum(monthly_submissions, big.mark = ",")` activities that were delivered in `r params$month` `r params$year`, **`r this_outcome %>% pull(sessions) %>% prettyNum(big.mark = ",")`** were said to have delivered against the [`r params$outcome` outcome](`r params$outcome_url`). In other words, **`r round((this_outcome$sessions/monthly_submissions)*100)`%** of the in-scope libraries activities delivered in `r params$month` `r params$year` were said to have delivered against the `r params$outcome` outcome.

```{r outcome_waffle}
this_outcome_waffle <- tibble(
  group = factor(c(params$outcome, paste0("Not ", params$outcome)), ordered = TRUE),
  value = c(this_outcome$sessions, (monthly_submissions-this_outcome$sessions))
) %>% 
  mutate(prop = round(value / sum(value) *100), .keep = "unused")

with_this_outcome <- this_outcome_waffle %>% 
  filter(group == params$outcome) %>% 
  pull(prop)

this_outcome_waffle %>% 
  deframe() %>% 
  waffle(
    colors = c("blue", "grey"),
    legend_pos = "bottom",
    title = paste0(with_this_outcome, "% of the in-scope libraries activities delivered in\n", paste0(params$month, " ", params$year), " were said to have delivered against the\n", params$outcome, " outcome"),
    xlab = paste0("1 square = 1% of programmes and events delivered in ", params$month, " ", params$year)
    )
```

```{r outcome_explorer_data}
outcome_explorer_data <- outcome_data %>% 
  distinct(id, .keep_all = TRUE) %>% 
  mutate(location = paste0(in_which_local_board_was_the_session_delivered, ": ", location), delivery_datetime = ymd_hms(delivery_datetime), delivery_date = stamp("Sunday, 30 November at 4.30pm", orders="AdBIMp", quiet = TRUE)(delivery_datetime),participants = (rowSums(across(starts_with("how_many_")), na.rm = TRUE))) %>% 
  select("Session Name" = what_was_the_name_of_the_session, "Format" = what_was_the_format_of_the_session, "Where was it delivered?" = location, "When was it delivered?" = delivery_date,  "How many people participated?" = participants)
```

For convenience, a limited view of the data for sessions that were said to have delivered against this outcome during `r params$month` `r params$year` has been provided below (a more comprehensive view of the data can be found in the [Data Explorer](https://aklcouncil-my.sharepoint.com/:u:/g/personal/durbinl_aklc_govt_nz/ES56_6mDLOZIqrzoyLDpwU0B7R5rNPIhN2MYSSzAr_CYTA?download=1)). You can click on the column headers to re-sort the table accordingly.

```{r outcome_explorer_table}
caption <- paste0('A table showing some information about sessions that were said to deliver against the ', params$outcome, ' outcome in ', params$month, ' ', params$year)
  
DT::datatable(
  outcome_explorer_data,
  caption = caption
)
```

Looking specifically at the activities in `r params$month` `r params$year` that were said to have delivered against the `r params$outcome` outcome, **`r prettyNum(this_outcome$participants_adult, big.mark = ",")` adults** and **`r prettyNum(this_outcome$participants_children, big.mark = ",")` children** attended these sessions. These sessions ran for a total of **`r prettyNum(round(this_outcome$duration), big.mark = ",")` hours**.

There are many ways to group these sessions, and in the data entry form we ask users to assign their session into one of the following broad categories:

* Book a Librarian
* Class or workshop
* Community event
* Club
* Live performance
* Pre-school activity
* Promotion or roadshow
* Talk
* Other (i.e. none of the above)

The following table shows, for each of these categories, the number sessions said to deliver against the `r params$outcome` outcome in `r paste0(params$month, " ", params$year)`, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r formats_table}
# What was the format of the session?
formats <- outcome_data %>% 
  filter(!is.na(what_was_the_format_of_the_session)) %>% 
  distinct(id, outcome, .keep_all = TRUE) %>% 
  summarise_data(what_was_the_format_of_the_session)

# Show this data in a table
caption <- paste0('Summary information per session format for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
basic_table(formats, "Session Format", caption)
```

And here is a graphical representation of the same information:

```{r formats_chart}
# Show the data in a chart
formats %>% 
  rename(format = what_was_the_format_of_the_session) %>% 
  basic_chart(format)
```


## Outcome Detail

```{r outcome_stats_data}
# Stats for sessions that delivered against a given outcome
outcome_stats <- outcome_data %>%
  distinct(id, outcome, outcome_attribute, .keep_all = TRUE) %>% 
  group_by(outcome_attribute) %>%
  summarise(
    sessions = n_distinct(id),
    participants_adult = sum(how_many_adults_aged_18_attended_in_person_at_this_session, na.rm = TRUE),
    participants_children = sum(how_many_children_aged_under_18_attended_in_person_at_this_session, na.rm = TRUE),
    duration = sum(what_was_the_duration_of_the_session_to_the_nearest_half_an_hour, na.rm = TRUE)/60
  )

show_outcome_stats_table <- nrow(outcome_stats) > 1
```

`r if(show_outcome_stats_table) {"This outcome area has several outcomes associated with it. The table below shows how many sessions were said to have delivered against each outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly."}`

```{r outcome_stats_table}
# Show outcome stats where there are multiple outcomes per outcome area
if(nrow(outcome_stats) > 1) {
  caption <- paste0('Summary information per ', params$outcome, ' outcome for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
  basic_table(outcome_stats, "Outcome", caption)
}
```

`r if(show_outcome_stats_table) {"And here is a graphical representation of the same information:"}`

```{r outcome_stats_chart}
if(nrow(outcome_stats) > 1) {
  outcome_stats %>% 
  basic_chart(outcome_attribute)
}
```


A session can deliver against more than one outcome. When sessions deliver against `r params$outcome`, the table below shows the number of times such sessions deliver against any of the other outcomes, as well as the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r outcome_crossover_table}
# Stats for sessions that delivered against this outcome area that also delivered against other outcome areas
outcomes_crossover <- outcomes %>% 
  filter(outcome != params$outcome) %>% 
  right_join(outcome_data %>% select(-outcome), "id") %>% 
  filter(!is.na(outcome)) %>% 
  distinct(id, outcome, .keep_all = TRUE) %>% 
  summarise_data(outcome) %>% 
  mutate(outcome = paste0(params$outcome, " + ", outcome))

  caption <- paste0('Summary information per crossover outcome for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
  basic_table(outcomes_crossover, "Outcome", caption)
```

And here is a graphical representation of the same information:

```{r outcome_crossover_chart}
  outcomes_crossover %>% 
  basic_chart(outcome)
```


## Delivery Location

```{r local_boards}
# In which Local Boards were these sessions delivered, to how many people, and for how long?
local_boards <- outcome_data %>% 
  distinct(id, .keep_all = TRUE) %>% 
  summarise_data(in_which_local_board_was_the_session_delivered) %>% 
  filter(!is.na(in_which_local_board_was_the_session_delivered))
```

Sessions that were said to have delivered against the `r params$outcome` outcome were held in **`r nrow(local_boards)`** Local Boards.

The table below shows, for each of these Local Boards, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r local_boards_table}
# Show this data in a table
  caption <- paste0('Summary information per Local Board for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)

  DT::datatable(
  local_boards,
  colnames = c('Local Board', common_table_headings),
  caption = caption
  )
```

And here is a graphical representation of the same information:

```{r local_boards_chart}
  local_boards %>% 
  basic_chart(in_which_local_board_was_the_session_delivered)
```

The following table shows more specifically where these activities were held:

```{r locations}
# Where were these sessions delivered, to how many people, and for how long?
locations <- outcome_data %>% 
  distinct(id, .keep_all = TRUE) %>% 
  summarise_data(location)

# Show this data in a table
caption <- paste0('Summary information per location for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)

  DT::datatable(
  locations,
  colnames = c('Location', common_table_headings),
  caption = caption
  )
```


## Delivery Agents

Programmes and events can be delivered or co-delivered by Connected Communities staff, Auckland Council staff not based in Connected Communities, and anyone not employed by Auckland Council (such as paid providers, volunteers, community groups, authors etc.).

The table below shows, for each of these types of delivery agents, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r delivery_agent_type_data}
# Which sorts of agents delivered them?
delivery_agent_type <- outcome_data %>% 
  select(id, outcome, CC_staff_agents:external_agents, how_many_adults_aged_18_attended_in_person_at_this_session, how_many_children_aged_under_18_attended_in_person_at_this_session, what_was_the_duration_of_the_session_to_the_nearest_half_an_hour) %>% 
  pivot_longer(CC_staff_agents:external_agents, names_to = "agent_type") %>% 
  filter(value == TRUE) %>% 
  mutate(agent_type = case_when(
    agent_type == "CC_staff_agents" ~ "Connected Communities staff",
    agent_type == "external_agents" ~ "Anyone not employed by Auckland Council",
    agent_type == "non_CC_staff_agents" ~ "Other Auckland Council staff"
  )) %>% 
  distinct(id, agent_type, .keep_all = TRUE) %>% 
  summarise_data(agent_type)

# Show this data in a table
caption <- paste0('Summary information per delivery agent type for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
basic_table(delivery_agent_type, "Delivery Agent Type", caption)
```

And here is a graphical representation of the same information:

```{r delivery_agent_type_chart}
  delivery_agent_type %>% 
  basic_chart(agent_type)
```


```{r placed_based_teams_data}
# Which placed-based teams delivered them?
placed_based_teams <- outcome_data %>% 
  filter(!is.na(delivery_library_names)) %>% 
  distinct(id, delivery_library_names, .keep_all = TRUE) %>% 
  summarise_data(delivery_library_names)
```

In Connected Communities there are placed-based teams (i.e. staff based in Community Libraries and Community Hubs) and teams who serve the region (i.e. Libraries and Learning Unit, Māori Outcomes Unit, Community Impact Unit, and Heritage and Arts Unit). In `r paste0(params$month, " ", params$year)`, **`r nrow(placed_based_teams)`** placed-based teams delivered or co-delivered sessions that were said to have delivered against the `r params$outcome` outcome.

The following table shows, for each placed-based team, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r placed_based_teams_table}
# Show this data in a table
  DT::datatable(
  placed_based_teams,
  colnames = c('Library or Hub Team', common_table_headings)
  )
```

```{r regional_teams_data}
# Which regional teams delivered them?
regional_teams <- outcome_data %>% 
  filter(!is.na(unit_names)) %>% 
  distinct(id, unit_names, .keep_all = TRUE) %>% 
  summarise_data(unit_names)
```

In `r paste0(params$month, " ", params$year)`, **`r nrow(regional_teams)`** regional teams delivered or co-delivered sessions that were said to have delivered against the `r params$outcome` outcome.

The following table shows, for each regional Unit, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r regional_teams_table}
# Show this data in a table
caption <- paste0('Summary information per regional Unit for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
basic_table(regional_teams, "Unit", caption)
```

## Intended Audiences

Some programmes and events were designed to benefit specific age groups. Of the `r this_outcome %>% pull(sessions) %>% prettyNum(big.mark = ",")` sessions that were said to deliver against the `r params$outcome` outcome in `r paste0(params$month, " ", params$year)`, **`r outcome_data %>% filter(!is.na(age_group)) %>% distinct(id) %>% nrow() %>% prettyNum(big.mark = ",")`** were designed to benefit a specific age group.

The following table shows, for each age group, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r age_groups}
# Which age groups were they designed to benefit?
age_groups <- outcome_data %>% 
  filter(!is.na(age_group)) %>% 
  distinct(id, age_group, .keep_all = TRUE) %>% 
  summarise_data(age_group)

# Show this data in a table
caption <- paste0('Summary information per target age group for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
basic_table(age_groups, "Target Age Group", caption)
```

And here is a graphical representation of the same information:

```{r age_groups_chart}
  age_groups %>% 
  basic_chart(age_group)
```

Some Community Libraries and Community Hubs reach out to particular groups in the community, such as new migrants, people on low incomes, people with no (or limited) qualifcations etc. Of the `r this_outcome %>% pull(sessions) %>% prettyNum(big.mark = ",")` sessions that were said to deliver against the `r params$outcome` outcome in `r paste0(params$month, " ", params$year)`, **`r outcome_data %>% filter(!is.na(target_group)) %>% distinct(id) %>% nrow() %>% prettyNum(big.mark = ",")`** were designed to benefit a group of interest.

The following table shows, for each group of interest, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r target_groups}
# Which other groups were they designed to benefit?
target_groups <- outcome_data %>% 
  filter(!is.na(target_group)) %>% 
  distinct(id, target_group, .keep_all = TRUE) %>% 
  summarise_data(target_group)

# Show this data in a table
caption <- paste0('Summary information per group of interest for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
basic_table(target_groups, "Group of Interest", caption)
```

And here is a graphical representation of the same information:

```{r target_groups_chart}
  target_groups %>% 
  basic_chart(target_group)
```


## Languages

In addition to English, we deliver programmes and events in a variety of other languages. In `r paste0(params$month, " ", params$year)`, a substantial part of **`r outcome_data %>% filter(!is.na(realm_language)) %>% distinct(id) %>% nrow() %>% prettyNum(big.mark = ",")`** `r params$outcome` sessions were delivered in languages other than English. By a "substantial part", we expect thar over half of the session was delivered in a language other than English.

The following table shows, for each language other than English, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r languages}
# Which non-English languages were they delivered in?
languages <- outcome_data %>% 
  filter(!is.na(realm_language)) %>% 
  distinct(id, realm_language, .keep_all = TRUE) %>% 
  summarise_data(realm_language)

# Show this data in a table
caption <- paste0('Summary information per language for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
basic_table(languages, "Realm Language", caption)
```

And here is a graphical representation of the same information:

```{r languages_chart}
  languages %>% 
  basic_chart(realm_language)
```


## Regional Theme

Some programmes and events are delivered in the context of a regional theme, which is occasionally supported by working groups and toolkits. In `r paste0(params$month, " ", params$year)`, **`r outcome_data %>% filter(!is.na(which_of_these_regional_or_national_events_was_the_session_designed_or_delivered_in_the_context_of)) %>% distinct(id) %>% nrow() %>% prettyNum(big.mark = ",")`** `r params$outcome` sessions were delivered in the context of one of the following regional themes:

* ANZAC Day
* Diwali
* Lunar New Year
* Matariki
* Pasifika Language Week
* Pride/Big Gay Out
* Regional Reading Programme
* School holidays
* Te wiki o te reo Māori
* Waitangi Day

The following table shows, for each regional theme, the number sessions said to deliver against the `r params$outcome` outcome, the number of adults (aged 18+) and children (aged under 18) who participated in these sessions, and the total duration of these sessions in hours. You can click on the column headers to re-sort the table accordingly.

```{r regional_themes}
# Which regional or national event was the session delivered in the context of?
regional_themes <- outcome_data %>% 
  filter(!is.na(which_of_these_regional_or_national_events_was_the_session_designed_or_delivered_in_the_context_of)) %>% 
  distinct(id, which_of_these_regional_or_national_events_was_the_session_designed_or_delivered_in_the_context_of, .keep_all = TRUE) %>% 
  summarise_data(which_of_these_regional_or_national_events_was_the_session_designed_or_delivered_in_the_context_of)

# Show this data in a table
caption <- paste0('Summary information per regional theme for the ', params$outcome, ' activities delivered in ', params$month, ' ', params$year)
basic_table(regional_themes, "Regional Theme", caption)
```

And here is a graphical representation of the same information:

```{r regional_themes_chart}
  regional_themes %>% 
  basic_chart(which_of_these_regional_or_national_events_was_the_session_designed_or_delivered_in_the_context_of)
```


## Appendix

```{r other_outcomes}
other_outcomes <- setdiff(c("Kia ora Tāmaki Makaurau", "Literacy", "Talanoa", "Tātou / Belonging", "Heritage", "Environment"), c(params$outcome)) %>% 
  str_replace("Tātou / Belonging", "Belonging") %>% 
  sort()

filepaths <- Sys.getenv() %>%
  enframe() %>%
  filter(word(name, 2, sep = fixed("_")) == "URL") %>% 
  mutate(value = as.character(value)) %>%
  pull(value)

other_reports <- setdiff(filepaths, params$outcome_file_location)
```

To view similar information on sessions held in `r paste0(params$month, " ", params$year)` that were said to deliver against the other outcome areas, you can download the relevant reports using the links below:

* [`r other_outcomes[1]`](`r (other_reports[1])`)
* [`r other_outcomes[2]`](`r (other_reports[2])`)
* [`r other_outcomes[3]`](`r (other_reports[3])`)
* [`r other_outcomes[4]`](`r (other_reports[4])`)
* [`r other_outcomes[5]`](`r (other_reports[5])`)
