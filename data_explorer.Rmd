---
title: "Programmes and Events Data Explorer"
author: "Lee Durbin"
date: "27/05/2021"
output:
  html_document
theme: lumen
always_allow_html: true
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

<img src="https://www.aucklandcouncil.govt.nz/_layouts/15/ACWeb/images/ac-logo-large.svg" alt="Auckland Council logo" title="Auckland Council" style="position:absolute;top:10px;right:10px;width:200px" />


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("reactable")
library("R.utils")
library("crosstalk")
library("htmltools")
library("tippy")

source("data_prep.R")

```

## Data Explorer

Here you can view data submitted via the Programmes and Events form since **July 1, 2021**.

The data was last refreshed on **`r stamp("Sunday, May 1 2000 at 1.30pm")(lastModified(files) %>% with_tz("NZ"))`**.

```{r data_explorer_prep, echo=FALSE, message=FALSE}

# Create these columns if they don't exist
cols <- read_csv("data/expected_column_headers.csv") %>% 
  as_tibble(.rows = NULL) %>% 
  add_row()

concat_libs <- delivery_agents %>% concat_rows(delivery_library_names)

concat_units <- delivery_agents %>% concat_rows(unit_names)

delivery_agents_explorer <- left_join(concat_libs, concat_units) %>% 
  unite("internal_delivery_teams", delivery_library_names:unit_names, sep = " --- ", na.rm = TRUE)

target_groups <- target_groups %>% 
  group_by(id) %>% 
  summarise(target_group = str_c(target_group, collapse = " --- "), .groups = "drop")

data_explorer_data <- plyr::join_all(list(base_table, delivery_agents_explorer, age_groups, target_groups, realm_languages), by="id", type="left") %>%
  mutate(age_group = word(age_group, 1), delivery_datetime = stamp("Sunday, May 1 2000 at 1.30pm")(delivery_datetime)) %>% 
  pivot_wider(names_from = age_group, values_from = age_group) %>% 
  mutate(
    submission_info = paste0("Data submitted by ", name, " on ", stamp("Sunday, May 1 2000 at 1.30pm")(submission_time %>% with_tz("NZ"))),
    duration_info = paste0(delivery_datetime, " for ", what_was_the_duration_of_the_session_to_the_nearest_half_an_hour),
    staff_info = case_when(
      is.na(how_many_connected_communities_staff_delivered_the_session) ~ "Connected Communities staff weren't involved in delivering this session",
      !is.na(how_many_connected_communities_staff_delivered_the_session) ~ paste0(how_many_connected_communities_staff_delivered_the_session, " Connected Communities staff delivered this session")
    )
    ) %>% 
  rowwise() %>% 
  mutate(
        offline_participants = sum(c(how_many_adults_aged_18_attended_in_person_at_this_session, how_many_children_aged_under_18_attended_in_person_at_this_session), na.rm = TRUE),
    online_participants = sum(c(how_many_adults_aged_18_watched_the_live_online_broadcast_of_this_session, how_many_children_aged_under_18_watched_the_live_online_broadcast_of_this_session, how_many_people_watched_the_live_online_broadcast_of_this_session), na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  select(-c(
    "NA",
    submission_time,
    email,
    starts_with("how_many_"),
    what_was_the_duration_of_the_session_to_the_nearest_half_an_hour,
    in_which_local_board_was_the_session_delivered,
    sublocation,
    in_person:online,
    realm_language
    )) %>% 
  unique() %>% 
  add_column(!!!cols[!names(cols) %in% names(.)]) %>% 
    mutate(across(c("Seniors", "Adults", "Youths", "Primary", "Pre-school"), ~case_when(
    is.na(.) ~ "\u2718",
    !is.na(.) ~ "\u2713"
  ))) %>% 
  select(id, duration_info, what_was_the_name_of_the_session, internal_delivery_teams, location, "Pre-school", Primary, Youths, Adults, Seniors, target_group, everything())

comments_table <- data_explorer_data %>% 
  select(id, Comments = please_use_the_box_below_to_write_any_further_comments_you_wish_to_make_about_this_session) %>% 
  mutate(Comments = case_when(
    is.na(Comments) ~ "No comments",
    !is.na(Comments) ~ Comments
  ))

data_explorer <- SharedData$new(data_explorer_data)

with_tooltip <- function(value, tooltip) {
  tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help",
            title = tooltip, value)
}

```


```{r data_explorer_table, echo=FALSE, warning=FALSE}

bscols(
  widths = c(2, 10),
  list(
    filter_select("location", "Delivery Location", data_explorer, ~ location),
    filter_select("name", "Data Provider", data_explorer, ~ name)
  ),
  reactable(
    data_explorer,
    showPageInfo = FALSE,
    theme = reactableTheme(
      # Vertically center cells
      cellStyle = list(
        display = "flex",
        flexDirection = "column",
        justifyContent = "center"
      )
    ),
    defaultSorted = list(delivery_datetime = "desc"),
    
    # Show user comments in a drop-down box
    details = function(index) {
      comments <-
        filter(comments_table, id == data_explorer$data()$id[index]) %>% select(Comments)
      tbl <-
        reactable(
          comments,
          outlined = TRUE,
          highlight = TRUE,
          fullWidth = TRUE
        )
      htmltools::div(style = list(margin = "12px 45px"), tbl)
    },
    onClick = "expand",
    rowStyle = list(cursor = "pointer"),
    
    columns = list(
      # **ID**
      id = colDef(
        name = "ID",
        cell = function(value, index) {
          submitted <- data_explorer$data()$submission_info[index]
          tagList(div(style = list(fontWeight = 600), value),
                  div(style = list(fontSize = 9), submitted))
        },
        style =
          JS(
            "function(rowInfo, colInfo, state) {
          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
          if (prevRow && rowInfo.row['id'] === prevRow['id']) {
            return { visibility: 'hidden' }
          }
      }"
          )
      ),
      
      # **Date**
      duration_info = colDef(
        header = with_tooltip(
          "Date",
          "Date and time that the activity started, and the duration of the session"
        ),
        aggregate = "unique",
        style =
          JS(
            "function(rowInfo, colInfo, state) {
          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
      }"
          )
      ),
      
      # **Description**
      what_was_the_name_of_the_session = colDef(
        name = "Description",
        cell = function(value, index) {
          format <-
            data_explorer$data()$what_was_the_format_of_the_session[index]
          tagList(div(style = list(fontWeight = 600), value),
                  div(style = list(fontSize = 10), format))
        },
        style =
          JS(
            "function(rowInfo, colInfo, state) {
          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
      }"
          )
      ),
      
      # **Delivery Agent(s)**
      internal_delivery_teams = colDef(
        header = with_tooltip(
          "Connected Communities Delivery Agent(s)",
          "A list of any Connected Communities staff who delivered the activity."
        ),
        cell = function(value, index) {
          staff <- data_explorer$data()$staff_info[index]
          tagList(
            div(style = list(fontWeight = 600), value),
            
            div(style = list(fontSize = 9), staff)
          )
        }
      ),
      
      # *Location**
      location = colDef(
        name = "Delivery Location",
        style =
          JS(
            "function(rowInfo, colInfo, state) {
          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
      }"
          )
      ),
      
      # **Target Age(s)**
      "Pre-school" = colDef(
        header = with_tooltip("Pre-school", "Targeted towards those aged under 5"),
        style = function(value) {
          color <-
            if (value == "\u2718") {
              "#e00000"
            } else if (value == "\u2713") {
              "#008000"
            }
          list(fontWeight = 600, color = color)
        }
      ),
      "Primary" = colDef(
        header = with_tooltip("Primary", "Targeted towards those aged between 5 and 12"),
        style = function(value) {
          color <-
            if (value == "\u2718") {
              "#e00000"
            } else if (value == "\u2713") {
              "#008000"
            }
          list(fontWeight = 600, color = color)
        }
      ),
      "Youths" = colDef(
        header = with_tooltip("Youths", "Targeted towards those aged between 13 and 24"),
        style = function(value) {
          color <-
            if (value == "\u2718") {
              "#e00000"
            } else if (value == "\u2713") {
              "#008000"
            }
          list(fontWeight = 600, color = color)
        }
      ),
      "Adults" = colDef(
        header = with_tooltip("Adults", "Targeted towards those aged between 25 and 64"),
        style = function(value) {
          color <-
            if (value == "\u2718") {
              "#e00000"
            } else if (value == "\u2713") {
              "#008000"
            }
          list(fontWeight = 600, color = color)
        }
      ),
      "Seniors" = colDef(
        header = with_tooltip("Seniors", "Targeted towards those aged 65 and older"),
        style = function(value) {
          color <-
            if (value == "\u2718") {
              "#e00000"
            } else if (value == "\u2713") {
              "#008000"
            }
          list(fontWeight = 600, color = color)
        }
      ),
      
      # **Target Group(s)**
      target_group = colDef(name = "Target Group(s)"),
      
      # **Theme**
      which_of_these_regional_or_national_events_was_the_session_designed_or_delivered_in_the_context_of = colDef(
        name = "Theme",
        style =
          JS(
            "function(rowInfo, colInfo, state) {
          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
      }"
          )
      ),
      
      # *Offline Participants**
      offline_participants = colDef(
        name = "In-Person Participants",
        style =
          JS(
            "function(rowInfo, colInfo, state) {
          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
      }"
          )
      ),
      
      # *Online Participants**
      online_participants = colDef(
        name = "Online Participants",
        style =
          JS(
            "function(rowInfo, colInfo, state) {
          var prevRow = state.pageRows[rowInfo.viewIndex - 1]
      }"
          )
      ),
      
      # **HIDDEN COLUMNS**
      submission_info = colDef(show = FALSE),
      name = colDef(show = FALSE),
      please_use_the_box_below_to_write_any_further_comments_you_wish_to_make_about_this_session = colDef(show = FALSE),
      delivery_datetime = colDef(show = FALSE),
      what_was_the_format_of_the_session = colDef(show = FALSE),
      staff_info = colDef(show = FALSE)
    ),
    columnGroups = list(colGroup(
      name = "Target Age Group(s)",
      columns = c("Pre-school", "Primary", "Youths", "Adults", "Seniors")
    )),
    highlight = TRUE
  )
)


```

