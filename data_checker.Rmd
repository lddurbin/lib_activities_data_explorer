---
title: "Programmes and Events Data Checker"
author: "Lee Durbin"
date: "19/07/2021"
output:
  html_document
theme: lumen
always_allow_html: true
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

<img src="https://www.aucklandcouncil.govt.nz/_layouts/15/ACWeb/images/ac-logo-large.svg" alt="Auckland Council logo" title="Auckland Council" style="position:absolute;top:10px;right:10px;width:200px" />


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("reactable", warn.conflicts = FALSE)
library("R.utils", warn.conflicts = FALSE)
library("crosstalk", warn.conflicts = FALSE)
library("htmltools", warn.conflicts = FALSE)
library("tippy", warn.conflicts = FALSE)

source("data_prep.R")

```

## Data Checker

Here you can view month-by-month summary information about data entry agent activity.

The data was last refreshed on **`r stamp("Sunday, May 1 2000 at 1.30pm")(lastModified(files) %>% with_tz("NZ"))`**.

The data will be refreshed on the first working day of each month.

```{r data_checker_prep, echo=FALSE, message=FALSE, warning=FALSE, message=FALSE}

base_table <- base_table %>% 
  mutate(submission_date = as_date(submission_time), location = as.character(location)) %>% 
  select(id, submission_date, location)

delivery_agents <- delivery_agents %>% 
  rowwise() %>% 
  mutate(delivery_library_names = case_when(
    is.na(delivery_library_names) ~ "Other AC staff or external",
    !is.na(delivery_library_names) ~ delivery_library_names
  )) %>% 
  ungroup() %>% 
  select(id, delivery_library_names)

checker_data <- left_join(base_table, delivery_agents, by = "id") %>% 
  rowwise() %>% 
  mutate(delivery_agent_or_location = case_when(
    location == "Other" ~ delivery_library_names,
    delivery_library_names == "Other AC staff or external" ~ location,
    location != "Other" ~ location,
    delivery_library_names != "Other AC staff or external" ~ delivery_library_names
  )) %>% 
  ungroup() %>% 
  mutate(submission_month = paste0(month(submission_date, label = TRUE, abbr = FALSE), " ", year(submission_date)))

monthly_entries <- checker_data %>% 
  count(submission_month, delivery_agent_or_location, name = "monthly_entries")

latest_entry <- checker_data %>% 
  group_by(submission_month, delivery_agent_or_location) %>% 
  summarise(latest_entry = max(submission_date), .groups = "drop") %>% 
  mutate(latest_entry = stamp("19 July, 2021", order = "dmy")(latest_entry))


```

```{r data_checker_table, echo=FALSE, warning=FALSE, include=TRUE}

data_checker <- left_join(monthly_entries, latest_entry, by = c("submission_month", "delivery_agent_or_location")) %>% 
  select(submission_month, delivery_agent_or_location, latest_entry, monthly_entries)

bscols(
  reactable(
    data_checker,
    height = 800,
    defaultPageSize = 20,
    defaultSorted = list(latest_entry = "asc"),
    showPageInfo = FALSE,
    theme = reactableTheme(
      # Vertically center cells
      cellStyle = list(
        display = "flex",
        flexDirection = "column",
        justifyContent = "center"
      )
    ),
    
    columns = list(
      
      #SUBMISSION MONTH
      submission_month = colDef(
        name = "Submission Month"
      ),
      
      #LOCATION OR DELIVERY AGENT
      delivery_agent_or_location = colDef(
        name = "Location or Delivery Agent"
      ),
      
      #LATEST ENTRY
      latest_entry = colDef(
        name = "Latest Entry"
      ),
      
      #MONTHLY ENTRIES
      monthly_entries = colDef(
        name = "Monthly Entries"
      )
    )
  )
)

```

