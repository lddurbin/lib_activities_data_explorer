---
title: "Libraries Programmes and Events Data Checker"
author: "Lee Durbin"
date: ""
output:
  html_document
theme: lumen
always_allow_html: true
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

<img src="https://www.aucklandcouncil.govt.nz/_layouts/15/ACWeb/images/ac-logo-large.svg" alt="Auckland Council logo" title="Auckland Council" style="position:absolute;top:10px;right:10px;width:200px" />


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("reactable", warn.conflicts = FALSE)
library("R.utils", warn.conflicts = FALSE)
library("crosstalk", warn.conflicts = FALSE)
library("htmltools", warn.conflicts = FALSE)
library("tippy", warn.conflicts = FALSE)

source(here::here("scripts/data_prep.R"))

```


Here you can view summary information about data entry agent activity.

This data was last refreshed on **`r stamp("Sunday, May 1 2000 at 1.30pm")(lastModified(files) %>% with_tz("NZ"))`**.

```{r data_checker_prep, echo=FALSE, message=FALSE, warning=FALSE, message=FALSE}

base_table_for_checker <- base_table_for_checker %>% 
  mutate(submission_date = as_date(submission_time), location = as.character(location)) %>% 
  select(id, submission_date, location) %>% 
  mutate(location = case_when(
    (location %in% normalised_locations$location) == TRUE ~ location,
    (location %in% normalised_locations$location) == FALSE ~ "Other")
  )

delivery_agents <- delivery_agents %>% 
  rowwise() %>% 
  mutate(delivery_library_names = case_when(
    is.na(delivery_library_names) ~ "Other AC staff or external",
    !is.na(delivery_library_names) ~ delivery_library_names
  )) %>% 
  ungroup() %>% 
  select(id, delivery_library_names)

checker_data <- left_join(base_table_for_checker, delivery_agents, by = "id") %>% 
  rowwise() %>% 
  mutate(delivery_agent_or_location = case_when(
    location == "Other" ~ delivery_library_names,
    delivery_library_names == "Other AC staff or external" ~ location,
    location != "Other" ~ location,
    delivery_library_names != "Other AC staff or external" ~ delivery_library_names
  )) %>% 
  ungroup()

monthly_entries <- checker_data %>% 
  mutate(
    days_since_submission = interval(submission_date, today()) %>% time_length("days"),
    days_since_submission = case_when(
      days_since_submission <= 30 ~ "Last 30 days",
      (days_since_submission > 30 & days_since_submission <= 60) ~ "From 31 to 60 days",
      days_since_submission > 60 ~ "More than 60 days"
    )
  ) %>% 
  filter(days_since_submission != "More than 60 days") %>% 
  count(delivery_agent_or_location, days_since_submission, name = "submissions")
  
change_in_entries <- monthly_entries %>% 
  pivot_wider(names_from = "days_since_submission", values_from = "submissions", values_fill = 0) %>% 
  clean_names() %>% 
  mutate(
    change_num = last_30_days - from_31_to_60_days
    )

latest_entry_data <- checker_data %>% 
  group_by(delivery_agent_or_location) %>% 
  summarise(latest_entry = max(submission_date), .groups = "drop") %>% 
  mutate(latest_entry_formatted = stamp("19 July, 2021", order = "dmy")(latest_entry))

expected_teams <- read_csv(here::here("data/expected_teams.csv"), col_types = "cc")

data_checker <- left_join(change_in_entries, latest_entry_data, by = c("delivery_agent_or_location")) %>% 
  select(delivery_agent_or_location, latest_entry_formatted, everything())

```

The following teams have not entered data through the form: **`r dplyr::setdiff(expected_teams$delivery_team, data_checker$delivery_agent_or_location)`**

```{r data_checker_table, echo=FALSE, warning=FALSE, include=TRUE}

bscols(
  reactable(
    data_checker,
    height = 800,
    defaultPageSize = 20,
    defaultSorted = list(latest_entry = "asc"),
    showPageInfo = FALSE,
    theme = reactableTheme(
      # Vertically center cells
      cellStyle = list(
        display = "flex",
        flexDirection = "column",
        justifyContent = "center"
      )
    ),
    
    columns = list(
      
      #LOCATION OR DELIVERY AGENT
      delivery_agent_or_location = colDef(
        name = "Location or Delivery Agent"
      ),
      
      #LATEST ENTRY
      latest_entry_formatted = colDef(
        name = "Latest Entry"
      ),
      
      #MONTHLY ENTRIES: LAST 30 DAYS
      last_30_days = colDef(
        name = "Entries (last 30 days)"
      ),
      
      #MONTHLY ENTRIES: 31 to 60 days
      from_31_to_60_days = colDef(
        name = "Entries (31 to 60 days)"
      ),
      
      #CHANGE IN MONTHLY ENTRIES
      change_num = colDef(
        name = "Change"
      ),
      
      #HIDDEN COLUMNS
      latest_entry = colDef(show = FALSE)
    )
  )
)

```

